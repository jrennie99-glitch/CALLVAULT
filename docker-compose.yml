# CallVault - Docker Compose Configuration
# Usage:
#   docker-compose up -d              # Start app + database
#   docker-compose --profile turn up -d  # Start with TURN server
#
# Make sure to copy .env.example to .env and configure your values first!

version: '3.8'

services:
  # =============================================================================
  # Main Application
  # =============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: callvault_app
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    environment:
      # Server
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5000
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost:5000}
      - TRUST_PROXY=${TRUST_PROXY:-true}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
      
      # Database
      - DATABASE_URL=${DATABASE_URL}
      
      # WebRTC / TURN
      - TURN_MODE=${TURN_MODE:-public}
      - TURN_URLS=${TURN_URLS:-}
      - TURN_USERNAME=${TURN_USERNAME:-}
      - TURN_CREDENTIAL=${TURN_CREDENTIAL:-}
      - TURN_SECRET=${TURN_SECRET:-}
      - STUN_URLS=${STUN_URLS:-stun:stun.l.google.com:19302}
      
      # Metered TURN
      - METERED_APP_NAME=${METERED_APP_NAME:-}
      - METERED_SECRET_KEY=${METERED_SECRET_KEY:-}
      
      # Push Notifications
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
      - VAPID_SUBJECT=${VAPID_SUBJECT:-mailto:admin@callvault.app}
      - FCM_SERVER_KEY=${FCM_SERVER_KEY:-}
      
      # Email
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-CallVault <noreply@callvault.app>}
      
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      
      # Solana
      - ENABLE_SOLANA_PAYMENTS=${ENABLE_SOLANA_PAYMENTS:-false}
      - SOLANA_CLUSTER=${SOLANA_CLUSTER:-mainnet-beta}
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-}
      - SOLANA_USDC_MINT=${SOLANA_USDC_MINT:-EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v}
      - SOL_USD_PRICE=${SOL_USD_PRICE:-}
      
      # Base/Ethereum
      - ENABLE_CRYPTO_PAYMENTS=${ENABLE_CRYPTO_PAYMENTS:-false}
      - BASE_USDC_CONTRACT=${BASE_USDC_CONTRACT:-0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913}
      - BASE_RPC_URL=${BASE_RPC_URL:-https://mainnet.base.org}
      - ETH_USD_PRICE=${ETH_USD_PRICE:-}
      - CRYPTO_INVOICE_EXPIRATION_MINUTES=${CRYPTO_INVOICE_EXPIRATION_MINUTES:-20}
      
      # AI Integrations
      - AI_INTEGRATIONS_GEMINI_API_KEY=${AI_INTEGRATIONS_GEMINI_API_KEY:-}
      - AI_INTEGRATIONS_GEMINI_BASE_URL=${AI_INTEGRATIONS_GEMINI_BASE_URL:-https://generativelanguage.googleapis.com}
      
      # Build info
      - BUILD_COMMIT=${BUILD_COMMIT:-unknown}
      - BUILD_TIME=${BUILD_TIME:-}
    volumes:
      - app_data:/app/data
      - app_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - callvault_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: callvault_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-callvault}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-callvault}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - callvault_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-callvault} -d ${POSTGRES_DB:-callvault}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Coturn TURN Server (Optional - enable with --profile turn)
  # =============================================================================
  coturn:
    image: coturn/coturn:latest
    container_name: callvault_turn
    restart: unless-stopped
    profiles:
      - turn  # Only starts when: docker-compose --profile turn up
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "5349:5349/tcp"
      - "5349:5349/udp"
      - "49152-65535:49152-65535/udp"
    environment:
      - TURN_USERNAME=${TURN_USERNAME:-callvault}
      - TURN_PASSWORD=${TURN_CREDENTIAL:-changeme}
    command:
      - -n
      - --log-file=stdout
      - --listening-port=3478
      - --tls-listening-port=5349
      - --min-port=49152
      - --max-port=65535
      - --realm=${TURN_REALM:-callvault.local}
      - --user=${TURN_USERNAME:-callvault}:${TURN_CREDENTIAL:-changeme}
      - --lt-cred-mech
      - --fingerprint
      - --no-tlsv1
      - --no-tlsv1_1
    networks:
      - callvault_network
    healthcheck:
      test: ["CMD-SHELL", "turnutils_uclient -e 127.0.0.1 || exit 0"]
      interval: 30s
      timeout: 5s
      retries: 3

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  app_data:
    driver: local
  app_uploads:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  callvault_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
