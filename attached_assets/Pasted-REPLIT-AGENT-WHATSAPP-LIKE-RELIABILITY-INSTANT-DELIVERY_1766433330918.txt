REPLIT AGENT — “WHATSAPP-LIKE” RELIABILITY + INSTANT DELIVERY UPGRADE (DO NOT REMOVE ANYTHING)

App: Call Vault (CV) is already built.
NON-NEGOTIABLE:
- DO NOT remove, rename, or break any existing features or functionality.
- Keep current security model (Ed25519 identities, signatures, Freeze Mode, WebAuthn lock) intact.
- Keep current UI look/feel; new UI must match.
- Keep existing billing/subscriptions working exactly as-is.
- Only ADD/REPAIR/IMPROVE. No rewrites.

GOAL
Make CV feel WhatsApp-like: instant messaging, reliable delivery, works across devices, predictable call setup, and smooth background alerts.

WHAT “WHATSAPP-LIKE” MEANS (PUBLIC BEHAVIORS TO MATCH)
Messaging:
1) Instant send + instant display (optimistic UI)
2) Guaranteed delivery with retries (no “silent drops”)
3) Correct ordering always (per conversation)
4) Read receipts + delivered receipts
5) Typing indicators (ephemeral)
6) Media sharing that always works (photos + videos)
7) Message search
8) Works across devices (user doesn’t lose messages on refresh/new device)

Calls:
9) Call setup that works over mobile data reliably (STUN + TURN fallback)
10) Clear connection state + auto recovery if network changes

Background availability:
11) If app is closed, user still receives a ring/notification (best effort on web/PWA; full reliability on native)

MANDATORY ENGINEERING CHANGES (ADD/IMPROVE ONLY)
A) REALTIME CHANNEL HARDENING
- Use WebSocket as primary; fall back to SSE/long-poll if WS fails.
- Implement heartbeat/ping + detect stale connections.
- On reconnect, “resume” using last_seen_message_id / last_event_seq.
- Implement backpressure handling so the client doesn’t lag under bursts.

B) MESSAGE RELIABILITY PIPELINE (WHATSAPP-LIKE)
- Add message states: queued -> sending -> sent -> delivered -> read
- Implement idempotency_key per message to prevent duplicates on retry.
- Implement server-side ACK:
  - Server returns ack(message_id, server_timestamp, seq)
  - Client updates status immediately.
- Ensure strict ordering:
  - Add per-conversation monotonically increasing seq generated by server.
  - Client renders based on seq (not client time).
- Add retry policy with exponential backoff.
- Add dead-letter logging + admin visibility for failed deliveries.

C) MEDIA (VIDEO) SHARING FIX + HARDENING
- Fix the picker so videos show on mobile (iOS/Android).
- Accept video MIME types: video/mp4, video/quicktime(mov), video/webm (where supported).
- Add upload progress + cancel.
- Store metadata in DB: type, size, duration (if available), thumbnail optional.
- Enforce limits by tier (Free vs Pro vs Business vs Founder) WITHOUT breaking current plans.
- Ensure secure media URLs (signed URLs / token gates) consistent with current security model.

D) CROSS-DEVICE SYNC (WHATSAPP FEEL)
- Ensure contacts/messages are not only local-storage:
  - Persist conversation state to DB so a new device/browser sees history.
  - Keep existing local cache but make server the source of truth.
- Add “sync cursor” endpoints:
  - GET /api/messages/sync?since_seq=...
  - GET /api/conversations/sync?since=...
- Ensure encryption/signature requirements remain intact.

E) BACKGROUND NOTIFICATIONS (WEB/PWA + NATIVE PATH)
- Web/PWA best-effort:
  - Add Service Worker push notifications for incoming call/message when browser supports it.
  - Use VAPID + Web Push for PWA.
  - If browser is fully closed and push is not allowed, show a clear limitation.
- Native (Android) for WhatsApp-level reliability:
  - Add Firebase Cloud Messaging (FCM) for call/message push wakeups.
  - Add “incoming call” push type and display a full-screen incoming call UI where supported.
  - Keep PWA working; do not remove it.

F) TIME/SIGNATURE/TIMESTAMP BUG FIX
- Fix “Invalid signature / expired timestamp” / “Secure session expired” issues:
  - Ensure server time is source of truth.
  - Add clock-skew tolerance window for signed payloads (e.g. ±300s).
  - Auto-refresh session tokens without user friction.
  - Add observability logs for signature failures.

G) PERFORMANCE
- Add DB indexes for:
  - messages(conversation_id, seq)
  - messages(sender_id, created_at)
  - receipts(message_id, user_id)
- Reduce re-render churn on client:
  - virtualized list for long chats
  - memoize message rows
- Add simple metrics:
  - message_send_latency_ms
  - ws_reconnect_count
  - media_upload_fail_rate

TEST PLAN (MUST RUN AND PASS)
- Burst test: send 100 messages fast; no drops; ordered correctly.
- Offline test: airplane mode -> queue -> reconnect -> deliver in order.
- Media test: send mp4 and mov from iPhone & Android; preview works.
- Cross-device: sign in on second device/browser; history appears.
- Realtime failure: kill WS -> fallback -> still works.
- Calls: over mobile data + restrictive network; TURN fallback works.
- No regressions to calls, billing, admin console, security.

DELIVERABLES
- List files changed/added
- Summary of what was fixed and why (messaging delay + video share issue)
- Confirm no features removed
- Any new env vars + exact values needed
- Show proof: screenshots/logs of tests passing